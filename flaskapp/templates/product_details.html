<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% if product.asin %}{{ product.asin }}{% else %}{{ product.title }}{% endif %} - Product Details
    </title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      .product-image img {
        max-width: 100%;
        height: auto;
      }
      .product-info {
        margin-top: 20px;
      }
      .reviews {
        margin-top: 40px;
      }
      .reviews h2 {
        margin-bottom: 20px;
      }
      .reviews ul {
        list-style-type: none;
        padding: 0;
      }
      .reviews li {
        border-bottom: 1px solid #ddd;
        padding: 20px 0;
        margin-bottom: 20px;
      }
      .review-details {
        color: #666;
        font-size: 0.9em;
      }
      .user-score {
        font-weight: bold;
        color: white;
        background-color: #007bff;
        padding: 5px 10px;
        border-radius: 5px;
        display: inline-block;
        margin-bottom: 10px;
      }
      .card-img-top {
        width: 200px;
        height: 200px;
      }
      .navbar {
        margin-bottom: 20px;
      }
      .btn-buy {
        margin-top: 20px;
      }
      .sort-dropdown {
        float: right;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/">Product Review</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          {% if session.get('user_id') %}
          <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="/login">Login</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <div class="container">
      <h1>
        {% if product.asin %}{{ product.asin }}{% else %}{{ product.title }}{% endif %}
      </h1>
      <div class="product-details">
        <div class="product-image">
          <img class="card-img-top" src="../static/product.jpg" alt="Product Image" />
        </div>
        <div class="product-info">
          <p class="price">$ {{ product.price }}</p>
          <p class="description">{{ product.description }}</p>
          <a href="{{ product.product_url }}" class="btn btn-primary btn-buy">Buy Now</a>
        </div>
      </div>

      <div class="reviews">
        <h2>
          Customer Reviews
          <div class="sort-dropdown">
            <label for="sortOrder">Sort by Trust Score:</label>
            <select id="sortOrder" class="form-control" onchange="sortReviews()">
              <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>High to Low</option>
              <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Low to High</option>
            </select>
          </div>
        </h2>
        {% if reviews %}
        <ul>
          {% for review in reviews %}
          <li>
            <span class="user-score">{{ review.trust_score }}</span>
            <h3>{{ review.title }}</h3>
            <p>{{ review.text }}</p>
            <p class="review-details">By {{ review.user_id }} on {{ review.timestamp }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p>No reviews yet.</p>
        {% endif %}
      </div>

      {% if session.get('user_id') %}
      <div class="add-review">
        <h2>Add a Review</h2>
        <form action="/submit_review" method="post">
          <input type="hidden" name="asin" value="{{ product.asin }}" />
          <div class="form-group">
            <label for="rating">Rating</label>
            <select class="form-control" id="rating" name="rating" required>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="form-group">
            <label for="title">Review Title</label>
            <input type="text" class="form-control" id="title" name="title" required />
          </div>
          <div class="form-group">
            <label for="text">Review Text</label>
            <textarea class="form-control" id="text" name="text" rows="3" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Submit Review</button>
        </form>
      </div>
      {% else %}
      <p><a href="/login">Login</a> to add a review.</p>
      {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      function sortReviews() {
        const sortOrder = document.getElementById('sortOrder').value;
        window.location.href = '?sort=' + sortOrder;
      }
    </script>
  </body>
</html>
